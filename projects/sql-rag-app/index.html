<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> SQL Database RAG App | Vincent Cheng Yun Sheng </title> <meta name="author" content="Vincent Cheng Yun Sheng"> <meta name="description" content="Building a simple SQL database RAG app"> <meta name="keywords" content="portfolio-website, data-science, data-analytics, ai"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/profile_pic.jpg?e8022a1151687468392a5d02ab42ebdd"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://cyshen11.github.io/projects/sql-rag-app/"> <script src="/assets/js/theme.js?bd888c560287cd675855c7662a167c4a"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Vincent</span> Cheng Yun Sheng </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">SQL Database RAG App</h1> <p class="post-description">Building a simple SQL database RAG app</p> </header> <article> <p>I wanted to learn how to use LLMs to query data from SQL databases, so I decided to build a web app and deploy it on the cloud. Here’s how I did it.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sql-rag-app/app_screenshot-480.webp 480w,/assets/img/sql-rag-app/app_screenshot-800.webp 800w,/assets/img/sql-rag-app/app_screenshot-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sql-rag-app/app_screenshot.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Application Screenshot" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p> </p> <h3 id="app"><a href="https://sql-chatbot-vincent-cheng.streamlit.app/" target="\_blank" rel="external nofollow noopener">App</a></h3> <h3 id="github"><a href="https://github.com/cyshen11/finance-chatbot/tree/main-sql-chatbot" target="\_blank" rel="external nofollow noopener">GitHub</a></h3> <h3 id="demo"><a href="https://youtu.be/bHhlXm2JrlE" target="\_blank" rel="external nofollow noopener">Demo</a></h3> <p> </p> <h2 id="tech-stack">Tech Stack</h2> <ul> <li>Frontend: Streamlit</li> <li>Database: SQLite</li> <li>Cloud: Streamlit community cloud</li> <li>LLM: OpenAI’s gpt-4o-mini</li> <li>Tools: LangChain</li> </ul> <p> </p> <p>The technology stack was carefully selected to balance functionality, ease of development, and cost efficiency. Streamlit was chosen as the frontend framework due to its rapid prototyping capabilities and Python-native development environment, making it ideal for data science applications. SQLite serves as the SQL database, aligning with the project’s core objective of building an SQL database query system. The application is hosted on Streamlit Community Cloud, providing a cost-effective deployment solution with built-in CD capabilities. For the language models, OpenAI’s GPT is chosen for its proven performance and extensive documentation. The entire application is orchestrated using LangChain, which provides a comprehensive framework for building RAG applications while abstracting away much of the complexity in connecting various components.</p> <p>   </p> <h2 id="architecture">Architecture</h2> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sql-rag-app/architecture.webp" sizes="95vw"></source> <img src="/assets/img/sql-rag-app/architecture.webp" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Architecture" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>   </p> <h2 id="step-1-setting-up-sqlite-for-database">Step 1: Setting up SQLite for Database</h2> <p>I started by creating the database component in <a href="https://github.com/cyshen11/finance-chatbot/blob/main-sql-chatbot/components/database.py" target="\_blank" rel="external nofollow noopener">database.py</a> to create SQLite database on-disk.</p> <p>There are 5 functions in this component, <code class="language-plaintext highlighter-rouge">create_tables</code>, <code class="language-plaintext highlighter-rouge">insert_ticker_data</code>, <code class="language-plaintext highlighter-rouge">create_database</code>, <code class="language-plaintext highlighter-rouge">test_database</code> and <code class="language-plaintext highlighter-rouge">check_db_exist</code>.</p> <ul> <li> <code class="language-plaintext highlighter-rouge">create_tables</code>: Creates companies, price_history, balance_sheets, income_statements tables with pre-defined schema</li> <li> <code class="language-plaintext highlighter-rouge">insert_ticker_data</code>: Inserts the past five years of data (company info, price history, balance sheet, and income statement) from Yahoo Finance via the <code class="language-plaintext highlighter-rouge">yfinance</code> library.</li> <li> <code class="language-plaintext highlighter-rouge">create_database</code>: Calls <code class="language-plaintext highlighter-rouge">create_tables</code> and <code class="language-plaintext highlighter-rouge">insert_ticker_data</code> functions with symbol parameter values such as AAPL, NVDA and GOOG</li> <li> <code class="language-plaintext highlighter-rouge">test_database</code>: Queries sample data from the tables for data validation</li> <li> <code class="language-plaintext highlighter-rouge">check_db_exist</code>: Calls <code class="language-plaintext highlighter-rouge">create_database</code> function. This function is called at the <a href="https://github.com/cyshen11/finance-chatbot/blob/main-sql-chatbot/pages/home.py" rel="external nofollow noopener" target="_blank">Home page</a> </li> </ul> <p> </p> <h2 id="step-2-generating-sql-query">Step 2: Generating SQL query</h2> <p>I developed the writer component in <a href="https://github.com/cyshen11/finance-chatbot/blob/main-sql-chatbot/components/writer.py" target="\_blank" rel="external nofollow noopener">writer.py</a> to generate SQL query.</p> <p>There are 2 functions, <code class="language-plaintext highlighter-rouge">init_llm</code> and <code class="language-plaintext highlighter-rouge">write_query</code>. There is 1 class <code class="language-plaintext highlighter-rouge">QueryOutput</code>.</p> <ul> <li> <code class="language-plaintext highlighter-rouge">init_llm</code>: Initializes LLM Open AI instance with gpt-4o-mini model</li> <li> <code class="language-plaintext highlighter-rouge">write_query</code>: Generates SQL query</li> <li> <code class="language-plaintext highlighter-rouge">QueryOutput</code>: Specifies the output required from the LLM</li> </ul> <p>For <code class="language-plaintext highlighter-rouge">write_query</code>, this function will</p> <ol> <li>Receive the <code class="language-plaintext highlighter-rouge">state</code> for the graph</li> <li>Pull prompt template from Langchain hub</li> <li>Connect to SQLite database in read-only mode to prevent unwanted modification to the database</li> <li>Update prompt with the database dialect, top <em>k</em> results, table info and user’s question</li> <li>Specify output required from LLM</li> <li>Invoke LLM with the updated prompt</li> <li>Return generated SQL query</li> </ol> <p> </p> <h2 id="step-3-executing-sql-query">Step 3: Executing SQL query</h2> <p>I developed the executor component in <a href="https://github.com/cyshen11/finance-chatbot/blob/main-sql-chatbot/components/executor.py" target="\_blank" rel="external nofollow noopener">executor.py</a> to execute SQL query.</p> <p>There is only 1 function, <code class="language-plaintext highlighter-rouge">execute_query</code>. This function will</p> <ol> <li>Connect to SQLite database in read-only mode to prevent unwanted modification to the database</li> <li>Execute SQL query</li> <li>Return query result</li> </ol> <p> </p> <h2 id="step-4-generating-answers">Step 4: Generating answers</h2> <p>I developed the generator component in <a href="https://github.com/cyshen11/finance-chatbot/blob/main-sql-chatbot/components/generator.py" target="\_blank" rel="external nofollow noopener">generator.py</a> to generate an answer based on the query result in response to the user’s question.</p> <p>There is only 1 function, <code class="language-plaintext highlighter-rouge">generate_answer</code>. This function will</p> <ol> <li>Initialize LLM OpenAI instance with gpt-4o-mini model</li> <li>Create prompt</li> <li>Invoke LLM with the updated prompt</li> <li>Return generated answer</li> </ol> <p> </p> <h2 id="step-5-creating-rag">Step 5: Creating RAG</h2> <p>I referred to this <a href="https://python.langchain.com/docs/tutorials/sql_qa/#human-in-the-loop" target="\_blank" rel="external nofollow noopener">LangChain documentation</a> Human-in-the-loop section to develop the graph component in <a href="https://github.com/cyshen11/finance-chatbot/blob/main-sql-chatbot/components/graph.py" target="\_blank" rel="external nofollow noopener">graph.py</a> to orchestrate the <code class="language-plaintext highlighter-rouge">writer</code>, <code class="language-plaintext highlighter-rouge">executor</code> and <code class="language-plaintext highlighter-rouge">generator</code> components. Below diagram shows the flow for the RAG whereby it will be interrupted before executing the query. It will continue executing the query once received input from the user.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sql-rag-app/rag_flow-480.webp 480w,/assets/img/sql-rag-app/rag_flow-800.webp 800w,/assets/img/sql-rag-app/rag_flow-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sql-rag-app/rag_flow.png" class="img-fluid rounded z-depth-1 w-25" width="100%" height="auto" alt="RAG Flow" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>(From <a href="https://python.langchain.com/docs/tutorials/sql_qa/#human-in-the-loop" target="\_blank" rel="external nofollow noopener">LangChain documentation</a>)</p> <p>There is 1 class, <code class="language-plaintext highlighter-rouge">Chatbot</code> with 6 methods, <code class="language-plaintext highlighter-rouge">build_graph</code>, <code class="language-plaintext highlighter-rouge">run_graph</code>, <code class="language-plaintext highlighter-rouge">continue_graph</code>, <code class="language-plaintext highlighter-rouge">update_query</code>, <code class="language-plaintext highlighter-rouge">string_tuples_to_markdown_table</code> and <code class="language-plaintext highlighter-rouge">extract_sql_headers</code>. This class is initialized with a Langgraph graph and config to specify the thread ID for continuing the run after user inputs.</p> <ul> <li> <code class="language-plaintext highlighter-rouge">build_graph</code>: Compiles RAG graph</li> <li> <code class="language-plaintext highlighter-rouge">run_graph</code>: Runs the RAG graph and returns the generated query</li> <li> <code class="language-plaintext highlighter-rouge">continue_graph</code>: Continues running the graph after receiving user inputs and returns the query result, generated answer</li> <li> <code class="language-plaintext highlighter-rouge">update_query</code>: Updates the graph state with the updated query</li> <li> <code class="language-plaintext highlighter-rouge">string_tuples_to_markdown_table</code>: Converts query result from tuples format to markdown format for displaying in the app</li> <li> <code class="language-plaintext highlighter-rouge">extract_sql_headers</code>: Extracts the column headers from the SQL query</li> </ul> <p>For <code class="language-plaintext highlighter-rouge">build_graph</code>, I compiled the graph with checkpointer so that it can be continued later. I specified the graph to be interrupted before the <code class="language-plaintext highlighter-rouge">execute_query</code> step to wait for user inputs.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">graph</span> <span class="o">=</span> <span class="n">graph_builder</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span>
    <span class="n">checkpointer</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
    <span class="n">interrupt_before</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">execute_query</span><span class="sh">"</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div> <p>For <code class="language-plaintext highlighter-rouge">run_graph</code>, I stream the graph by providing user’s question as the input.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">question</span><span class="sh">"</span><span class="p">:</span> <span class="n">question</span><span class="p">},</span>
    <span class="n">self</span><span class="p">.</span><span class="n">config</span><span class="p">,</span>
    <span class="n">stream_mode</span><span class="o">=</span><span class="sh">"</span><span class="s">updates</span><span class="sh">"</span><span class="p">,</span>
<span class="p">):</span>
</code></pre></div></div> <p>However, for <code class="language-plaintext highlighter-rouge">continue_graph</code>, the graph is streamed without providing any input as it is not required.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="nf">stream</span><span class="p">(</span>
    <span class="bp">None</span><span class="p">,</span>
    <span class="n">self</span><span class="p">.</span><span class="n">config</span><span class="p">,</span>
    <span class="n">stream_mode</span><span class="o">=</span><span class="sh">"</span><span class="s">updates</span><span class="sh">"</span><span class="p">,</span>
<span class="p">):</span>
</code></pre></div></div> <p>For <code class="language-plaintext highlighter-rouge">update_query</code>, I updated the graph state with the query to the <code class="language-plaintext highlighter-rouge">write_query</code> node.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">self</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="nf">update_state</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span> <span class="n">as_node</span><span class="o">=</span><span class="sh">"</span><span class="s">write_query</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p>Besides the <code class="language-plaintext highlighter-rouge">graph</code> component, I also developed the RAG state in <a href="https://github.com/cyshen11/finance-chatbot/blob/main-sql-chatbot/components/utils.py" target="\_blank" rel="external nofollow noopener">utils.py</a>. The RAG state class is used by the RAG to keep track of its state. It is a class and has 4 attributes.</p> <ul> <li> <code class="language-plaintext highlighter-rouge">question</code>: User’s question</li> <li> <code class="language-plaintext highlighter-rouge">query</code>: SQL query</li> <li> <code class="language-plaintext highlighter-rouge">result</code>: Query result</li> <li> <code class="language-plaintext highlighter-rouge">answer</code>: Generated answer</li> </ul> <h2 id="step-6-creating-user-interface">Step 6: Creating user interface</h2> <p>The chatbot interface component is located <a href="https://github.com/cyshen11/finance-chatbot/blob/main-sql-chatbot/pages/home.py" target="\_blank" rel="external nofollow noopener">here</a> based on <a href="https://docs.streamlit.io/develop/tutorials/llms/build-conversational-apps" target="\_blank" rel="external nofollow noopener">Streamlit Documentation</a>.</p> <p>Firstly, the app will check if the SQLite database exist. If it is not, it will create the database by calling <code class="language-plaintext highlighter-rouge">check_db_exist</code> function. It will also get the OpenAI API key from the environment which provided by the user in the sidebar input.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">openai_api_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">"</span><span class="s">OPENAI_API_KEY</span><span class="sh">"</span><span class="p">]</span>
</code></pre></div></div> <p>There are 2 functions, <code class="language-plaintext highlighter-rouge">update_session_state</code> and <code class="language-plaintext highlighter-rouge">write_chat_message</code>. <code class="language-plaintext highlighter-rouge">update_session_state</code> is used to save user input to the chat history and in the session state. <code class="language-plaintext highlighter-rouge">write_chat_message</code> is used to output message in the chat interface for the provided role and save in the chat history.</p> <p>This page will initialize the <code class="language-plaintext highlighter-rouge">ChatBot</code> instance when it is first loaded and output startup message. It will also set the session <code class="language-plaintext highlighter-rouge">verification_status</code> (variable to capture user input) as <em>New</em> and <code class="language-plaintext highlighter-rouge">sql_query</code> as blank.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sql-rag-app/app_screenshot-480.webp 480w,/assets/img/sql-rag-app/app_screenshot-800.webp 800w,/assets/img/sql-rag-app/app_screenshot-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sql-rag-app/app_screenshot.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Application Screenshot" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>This page will continuously display the chat history throughout the session.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">chat_history</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">st</span><span class="p">.</span><span class="nf">chat_message</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">]):</span>
        <span class="n">st</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">])</span>
</code></pre></div></div> <p>When user submitted question in the chat interface and the session <code class="language-plaintext highlighter-rouge">verification_status</code> is <em>New</em>, the <code class="language-plaintext highlighter-rouge">ChatBot</code> will run the RAG with the user’s question. It will then respond with the generated SQL query and 2 buttons, <code class="language-plaintext highlighter-rouge">Run query</code> and <code class="language-plaintext highlighter-rouge">Modify</code>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">prompt</span> <span class="p">:</span><span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">chat_input</span><span class="p">(</span><span class="sh">"</span><span class="s">Ask a question about the database</span><span class="sh">"</span><span class="p">):</span>
    <span class="c1"># User ask new query
</span>    <span class="k">if</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">verification_status</span> <span class="o">==</span> <span class="sh">"</span><span class="s">New</span><span class="sh">"</span><span class="p">:</span>
        <span class="nf">write_chat_message</span><span class="p">(</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">chatbot</span><span class="p">.</span><span class="nf">run_graph</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="nf">write_chat_message</span><span class="p">(</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

            <span class="c1"># Create buttons
</span>            <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="nf">columns</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">col1</span><span class="p">.</span><span class="nf">button</span><span class="p">(</span><span class="sh">"</span><span class="s">Run query</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">approve_btn</span><span class="sh">"</span><span class="p">,</span> <span class="n">on_click</span><span class="o">=</span><span class="n">update_session_state</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">Run query</span><span class="sh">'</span><span class="p">])</span>
            <span class="n">col2</span><span class="p">.</span><span class="nf">button</span><span class="p">(</span><span class="sh">"</span><span class="s">Modify</span><span class="sh">"</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="sh">"</span><span class="s">modify_btn</span><span class="sh">"</span><span class="p">,</span> <span class="n">on_click</span><span class="o">=</span><span class="n">update_session_state</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">Modify query</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sql-rag-app/generate_query-480.webp 480w,/assets/img/sql-rag-app/generate_query-800.webp 800w,/assets/img/sql-rag-app/generate_query-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sql-rag-app/generate_query.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Generate SQL Query" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>If user clicked <code class="language-plaintext highlighter-rouge">Run query</code>, the app will update the session <code class="language-plaintext highlighter-rouge">verification_status</code> to <em>Run query</em> and the <code class="language-plaintext highlighter-rouge">ChatBot</code> will continue running to execute the query and generate the answer.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># User clicked run query
</span><span class="k">if</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">verification_status</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Run query</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">chatbot</span><span class="p">.</span><span class="nf">continue_graph</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
        <span class="nf">write_chat_message</span><span class="p">(</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">verification_status</span> <span class="o">=</span> <span class="sh">"</span><span class="s">New</span><span class="sh">"</span>
</code></pre></div></div> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sql-rag-app/run_query-480.webp 480w,/assets/img/sql-rag-app/run_query-800.webp 800w,/assets/img/sql-rag-app/run_query-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sql-rag-app/run_query.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Run Query" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>If user clicked <code class="language-plaintext highlighter-rouge">Modify</code>, the app will update the session <code class="language-plaintext highlighter-rouge">verification_status</code> to <em>Modify query</em> and <code class="language-plaintext highlighter-rouge">Chatbot</code> will ask user to provide modified query.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># User clicked modify query
</span><span class="k">if</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">verification_status</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Modify query</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Please provide modified query.</span><span class="sh">"</span>
    <span class="nf">write_chat_message</span><span class="p">(</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</code></pre></div></div> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sql-rag-app/modify_query-480.webp 480w,/assets/img/sql-rag-app/modify_query-800.webp 800w,/assets/img/sql-rag-app/modify_query-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sql-rag-app/modify_query.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Modify Query" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>If user submitted valid query, the <code class="language-plaintext highlighter-rouge">ChatBot</code> will continue to execute with the new query and generate the answer. If there is error in executing the query, the app will update the session <code class="language-plaintext highlighter-rouge">verification_status</code> to <em>Query invalid</em>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># User provided query
</span><span class="k">elif</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">verification_status</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Modify query</span><span class="sh">"</span> <span class="ow">or</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">verification_status</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Query invalid</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">write_chat_message</span><span class="p">(</span><span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">`</span><span class="sh">"</span> <span class="o">+</span> <span class="n">prompt</span> <span class="o">+</span> <span class="sh">"</span><span class="s">`</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">chatbot</span><span class="p">.</span><span class="nf">update_query</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">chatbot</span><span class="p">.</span><span class="nf">continue_graph</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="nf">write_chat_message</span><span class="p">(</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">verification_status</span> <span class="o">=</span> <span class="sh">"</span><span class="s">New</span><span class="sh">"</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">verification_status</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Query invalid</span><span class="sh">"</span>
</code></pre></div></div> <p>If the session <code class="language-plaintext highlighter-rouge">verification_status</code> is <em>Query invalid</em>, the <code class="language-plaintext highlighter-rouge">ChatBot</code> will ask the user to submit query that is SQLite3 dialect.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Query provided by user is invalid
</span><span class="k">if</span> <span class="n">st</span><span class="p">.</span><span class="n">session_state</span><span class="p">.</span><span class="n">verification_status</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Query invalid</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Query is not supported. Please write query that is SQLite3 dialect.</span><span class="sh">"</span>
    <span class="nf">write_chat_message</span><span class="p">(</span><span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</code></pre></div></div> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sql-rag-app/query_invalid-480.webp 480w,/assets/img/sql-rag-app/query_invalid-800.webp 800w,/assets/img/sql-rag-app/query_invalid-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sql-rag-app/query_invalid.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Invalid Query" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h2 id="step-7-deploying-to-streamlit-community-cloud">Step 7: Deploying to Streamlit Community Cloud</h2> <p>Lastly, I deployed the app to Streamlit Community Cloud from my GitHub for free hosting. I configured the repo, branch, main file path, python version (3.10) and the Streamlit secrets.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/sharepoint-rag-app/deploy-480.webp 480w,/assets/img/sharepoint-rag-app/deploy-800.webp 800w,/assets/img/sharepoint-rag-app/deploy-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/sharepoint-rag-app/deploy.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" alt="Deploy to Streamlit" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h2 id="afterthoughts">Afterthoughts</h2> <p><strong>The Risk of Autonomous SQL Execution</strong> Building a “Text-to-SQL” system revealed a critical safety challenge: LLMs can hallucinate destructive queries (e.g., <code class="language-plaintext highlighter-rouge">DROP TABLE</code>) or syntactically incorrect SQL. To mitigate this, I implemented two layers of defense:</p> <ol> <li> <strong>Architecutre</strong>: A Human-in-the-loop (HITL) workflow using <strong>LangGraph checkpoints</strong>, requiring user approval before any SQL is executed.</li> <li> <strong>Infrastructure</strong>: Enforcing <strong>Read-Only</strong> database connections at the driver level to prevent data corruption.</li> </ol> <p><strong>LangGraph for State Management</strong> Unlike a standard RAG application, a SQL agent requires complex state management (tracking the generated query, user modifications, and execution results). <strong>LangGraph</strong> provided superior to linear chains here, allowing me to treat the “Modify Query” step as a cyclic node in the graph state, effectively enabling a conversation with the database.</p> <p><strong>Future Enhancements</strong></p> <ul> <li>Adding a Schema Explorer sidebar so users can see available columns (e.g., <code class="language-plaintext highlighter-rouge">NVDA</code>, <code class="language-plaintext highlighter-rouge">High</code>, <code class="language-plaintext highlighter-rouge">Volume</code>) before asking questions</li> <li>Find actual use case for this project</li> </ul> <h2 id="references">References</h2> <ul> <li>LangChain, <a href="https://python.langchain.com/docs/tutorials/sql_qa/#human-in-the-loop" target="\_blank" rel="external nofollow noopener">Build a Question/Answering system over SQL data</a> </li> <li>LangChain, <a href="https://langchain-ai.github.io/langgraph/how-tos/human_in_the_loop/time-travel/#interacting-with-the-agent" target="\_blank" rel="external nofollow noopener">How to view and update past graph state</a> </li> </ul> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Vincent Cheng Yun Sheng. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?3e7054dc4d3e3dd8f0731a48453e618e"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?3577194613afa04501eb52f8f4164de9" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?70d799092f862ad98c7876aa47712e20"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>